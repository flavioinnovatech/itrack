{% extends "templates/base.html" %}

{% block head %}

<link rel="stylesheet" href="/media/css/multiselect.css" type="text/css" media="screen" />
<script type="text/javascript" src="http://jscolor.com/jscolor/jscolor.js"></script>
<script type="text/javascript" src="/static/admin/js/core.js"></script>
<script type="text/javascript" src="/static/admin/js/getElementsBySelector.js"></script>
<script type="text/javascript" src="/static/admin/js/actions.js"></script>
<script type="text/javascript" src="/static/admin/js/SelectBox.js"></script>
<script type="text/javascript" src="/static/admin/js/SelectFilter2.js"></script>
<script type="text/javascript" src="/media/js/jsi18n.js"></script>
<script type="text/javascript" src="/media/js/jquery-ui-timepicker-addon.js"></script>
<script type="text/javascript" src="/media/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/media/js/loading.js"></script>
<style type="text/css">

    .field #id_vehicle{
        width:165px;
    }
    .field {
        height:30px;
    }
    .field #id_vehicle_other{
        margin:0;
    }
    .field .switcher{
        width:165px;
        height:20px;
    }
    .vehiclass{
        margin-left: 15px;
    }
    
</style>
<script type="text/javascript">
$(document).ready(function(){
    
    var fileDownloadCheckTimer;
    function blockUIForDownload() {
    var token = new Date().getTime(); //use the current timestamp as the token value
    $('#download_token_value_id').val(token);
    openloading();
    
    fileDownloadCheckTimer = window.setInterval(function () {
      var cookieValue = $.cookie('fileDownloadToken');
      if (cookieValue == token)
       finishDownload();
    }, 1000);
    }
  
    function finishDownload() {
        window.clearInterval(fileDownloadCheckTimer);
        $.cookie('fileDownloadToken', null); //clears this cookie value
        closeloading();
    } 
    
     // CONFIGURAÇÃO DO DATEPICKER DO JQUERYUI PARA PT-BR
	$.datepicker.setDefaults({dateFormat: 'dd/mm/yy',
        dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado','Domingo'],
        dayNamesMin: ['D','S','T','Q','Q','S','S','D'],
        dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb','Dom'],
        monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro', 'Outubro','Novembro','Dezembro'],
        monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set', 'Out','Nov','Dez'],
        nextText: 'Próximo',
    	prevText: 'Anterior'
    });    
        
    $.timepicker.setDefaults({
		timeOnlyTitle: 'Выберите время',
		timeText: 'Horário',
		hourText: 'Hora',
		minuteText: 'Minuto',
		secondText: 'Segundo',
		currentText: 'Hora atual',
		closeText: 'Ok',
		ampm: false
	});
     
    //limiting the maximum and minimum dates
    dates = $( "#id_period_end, #id_period_start " ).datetimepicker({
			showSecond: true,
            timeFormat: 'hh:mm:ss',
            dateFormat: 'yy-mm-dd',
			onSelect: function( selectedDate ) {
				var option = this.id == "id_period_start" ? "minDate" : "maxDate",
					instance = $( this ).data( "datepicker" ),
					date = $.datepicker.parseDate(
						instance.settings.dateFormat ||
						$.datepicker._defaults.dateFormat,
						selectedDate, instance.settings );
				
				date2  = new Date(date);
				date2.setMonth(date.getMonth()+ (this.id == "id_period_start" ? 1 : -1));
                
				var option2 = this.id == "id_period_start" ? "maxDate" : "minDate";				    
					
				dates.not( this ).datetimepicker( "option", option, date );
				dates.not( this ).datetimepicker( "option", option2, date2);
			}
		});
    
    if ($('.switcher option:selected').text() == 'Outro:'){
        this.id = 'id_vehicle_other';
        $(this).attr('name','vehicle_other');
        $(this).parent().append("<input type=\"text\" placeholder=\"Digite a placa\" id=\"id_vehicle\" class=\"vehiclass\" name=\"vehicle\" >");
    }else if(this.id == 'id_vehicle_other'){
        $('#id_vehicle').remove()
        this.id = 'id_vehicle';
        $(this).attr('name','vehicle');
    }
    
    
    $('.switcher').change(function(){
        if ($('.switcher option:selected').text() == 'Outro:'){
            this.id = 'id_vehicle_other';
            $(this).attr('name','vehicle_other');
            $(this).parent().append("<input type=\"text\" placeholder=\"Digite a placa\" id=\"id_vehicle\" class=\"vehiclass\" name=\"vehicle\" >");
        }else if(this.id == 'id_vehicle_other'){
            $('#id_vehicle').remove()
            this.id = 'id_vehicle';
            $(this).attr('name','vehicle');
        } 
    });
    
    /*
    <p class="field">
        <select name="vehicle" id="id_vehicle">
            <option value="1">CXP1337</option>
            <option value="-1">Outro</option>
        </select> 
    </p>
    */
    $('#exportCSV').click(function(){
        $('input[name="type"]').attr("value","CSV");
        document.forms["formz"].submit();
        blockUIForDownload();
    });
    
    
    $('#exportPDF').click(function(){
        $('input[name="type"]').attr("value","PDF");
        document.forms["formz"].submit();
        blockUIForDownload();
    });
    
    $('#exportHTML').click(function(){
        $('input[name="type"]').attr("value","HTML");
        document.forms["formz"].submit();
        blockUIForDownload();
    });
    
    if({{no_information}}){
        alert("Não foram encontrados dados para a busca realizada. Por favor, tente novamente");    
    }  
});
</script>

{% endblock %}


{% block content %}


<div  class="main-form">
{% block form_title %}
<h1><img class="icon" src="/media/img/calendar.png">Processar Relatório </h1>
<hr />
<h2>Filtros</h2>
<em>Informe qual o período e veículo do relatório, e quais campos devem aparecer na tabela.</em>
{% endblock %}
<form action="." method="post" enctype="multipart/form-data" id="formz">{% csrf_token %}
      <table>
    {% for field in form %}

        <tr>
        <div class="form-item">
        {% if field.label == 'Fields' or field.label == 'Vehicle fields' %}
        <td>
            <div class="item-alone">          
                  <p class="errorlist">{{ field.errors }} </p>
                <p class="field">{{ field }} </p>          
            </div>
        </td>
        <td>

        </td>
        {% else %}
        <td>
            <div class="item-left">          
                  <p>{{ field.label_tag }} {%if field.field.required%} *{%endif%}</p>
                  <p id="help">{{ field.help_text|wordwrap:"50"|linebreaksbr }} </p>
            </div>
        </td>
        
        <td>
            <div class="item-right">
                <p class="errorlist">{{ field.errors }} </p>
                <p class="field">{{ field }} </p>          
            </div>
        </td>
        {% endif %}
        
        </div>
        </tr>
    {% endfor %}
    </table>
{{ previous_fields|safe }}
<input type="hidden" name="type" />
<input type="hidden" id="download_token_value_id" name="token" />
<input type="submit" value="Exportar como CSV" class="table-button" style="padding:10px;float:right;" id="exportCSV" />
<!-- <input type="submit" value="Exportar como PDF" class="table-button" style="padding:10px;float:right;" id="exportPDF" />
<input type="submit" value="Exportar como HTML" class="table-button" style="padding:10px;float:right;" id="exportHTML" /> -->
<p class="clear">
</form>

</div>
{% endblock %}

{% extends "templates/base.html" %}

{% block head %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="/media/js/polygon(1.0).js"></script>


<script type="text/javascript">

$(document).ready(function(){
  $(".main-form").css("height","450px");
  
  $("#accordion").accordion({ 
      autoHeight: true
  });
  
  var geocoder;
	var map;
	var infowindow = new google.maps.InfoWindow();
	var marker;
	geocoder = new google.maps.Geocoder();
	
	var input = "-22.896359,-47.060092";
	var latlngStr = input.split(",",2); 
	var lat = parseFloat(latlngStr[0]);
	var lng = parseFloat(latlngStr[1]);
	var latlng = new google.maps.LatLng(lat, lng);
	var myOptions = {
		zoom: 4,
		center: latlng,
		mapTypeId: 'roadmap'
	}
  map = new google.maps.Map(document.getElementById("map"), myOptions);
  
  google.maps.event.addListener(map, "mousemove", function(pos){
     $("#lat").val(pos.latLng.lat().toFixed(10));
     $("#lng").val(pos.latLng.lng().toFixed(10));
   });
  
  creator = new PolygonCreator(map);
  
  var geofences = [];
  
  ///////////// Cirlce tools
  $("#circletool").click(function() {
    creator.destroy();
          
    if (isNaN(parseInt($("#radius").val()))) {
      alert('Digite um número válido para o raio');
    }

    else {
      
      //Only one geofence/time
      if (geofences.length > 0) {
        geofences[0].setMap(null);
        geofences.pop();
      }
      
      google.maps.event.addDomListenerOnce(map,"click",function(point){
      
        radius = parseInt($("#radius").val());

        circle = new google.maps.Circle({
          center : point.latLng,
          map : map,
          strokeColor : "#FFAA00",
          radius : radius
        });

        geofences.push(circle);

        $("#savecircle").removeAttr('disabled');
         
      });
      
      
      
      // $("#savecircle").click(function(){
      //         alert('ae');
      //       });
      
    }
  
  });
  
  $("#circlesubmit").submit(function(){
    creator.destroy();
      
    if (isNaN(parseInt($("#radius").val()))) {
      alert('Digite um número válido para o raio');
    }
    
    else {
      
      //Only one geofence/time
      if (geofences.length > 0) {
        geofences[0].setMap(null);
        geofences.pop();
      }
      
      address = $("#circlecenter").attr("value");
      radius = parseInt($("#radius").val());
      
      geocoder.geocode( { 'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
          position = results[0].geometry.location;
          
          circle = new google.maps.Circle({
            center : position,
            map : map,
            strokeColor : "#FFAA00",
            radius : radius
          });
          
          geofences.push(circle);
          
        } else {
          alert("Geocode was not successful for the following reason: " + status);
        }
      });
    }
    
  });
  
  ///////////// Polygon tool
  $("#polygontool").click(function(){
    creator.destroy();
    creator = new PolygonCreator(map);
    
     if (geofences.length > 0) {
        geofences[0].setMap(null);
        geofences.pop();
      }
        
  });
  
  ///////////// Route
  $("#routetool").click(function(){

     creator.destroy();
     var directionDisplay;
     var directionsService = new google.maps.DirectionsService();
     directionsDisplay = new google.maps.DirectionsRenderer();
     directionsDisplay.setMap(map);
     
     if (geofences.length > 0) {
       geofences[0].setMap(null);
       geofences.pop();
     }

       google.maps.event.addListenerOnce(map,"click",function(point){

         var start = point.latLng

         google.maps.event.addListenerOnce(map,"click",function(point){ 

         var request = {
           origin:start, 
           destination:point.latLng,
           travelMode: google.maps.DirectionsTravelMode.DRIVING
         };
         directionsService.route(request, function(result, status) {
           if (status == google.maps.DirectionsStatus.OK) {
             directionsDisplay.setDirections(result);

             $("#saveroute").removeAttr('disabled');
             
             geofences.push(directionsDisplay);
           }

           else {
             alert('Rota inválida');
           }
         });

       });
     });
  });
  
  
});
  
</script>
{% endblock %}

{% block content %}
<div  class="main-form">

  <div style="float:left;width:20%;height:100%;">
   <p>Posição do cursor:</p>
   <p><span style="text-align:right;">Latitude:</span><input id="lat" type="text" style="margin: 5px 0 5px 5px;width: 118px;position:relative;left:10px;"></input></p>
   <p>Longitude:<input id="lng" type="text" style="margin: 5px 0 5px 4px;width: 118px;"></input></p>
   <div id="accordion" style="height:100%;">
     <h3><a href="#">Círculo</a></h3>
       <div>
         <p>Digite um raio e em seguida selecione um centro:</p><br/>
         <input type="text" id="radius" style="width:93px;"></input> metros <br/><br/><hr/><br/>
         <p align="center"><span class="table-button" id="circletool" style="cursor:pointer;padding:5px;">Marcar centro</span></p><br><br/>
         <p align="left">Ou digitar endereço do centro:</p>
         <form id="circlesubmit" style="margin-top:5px;width:auto;" action="#map">
           <p><input id="circlecenter" type="text"></input></p></br/>
         </form>
         <input id="savecircle" type="submit" value="Salvar cerca eletrônica" style="float:right;"></input>
       </div>
     <h3><a href="#">Polígono</a></h3>
       <div>
         <p>Clique no botão abaixo para selecionar os vértices do polígono no mapa:</p><br/>
         <p align="center"><span class="table-button"  id="polygontool" style="cursor:pointer;padding:5px;">Traçar polígono</span></p><br><br/>
         <input id="savepolygon" type="submit" value="Salvar cerca eletrônica" style="float:right;"></input>      </div>
     <h3><a href="#">Rota</a></h3>
       <div>
         <p>Clique no botão abaixo e em seguida selecione uma rua para origem e uma rua para destino</p><br/>
         <p align="center"><span class="table-button"  id="routetool"  style="cursor:pointer;padding:5px;">Selecionar rota</span></p><br/><br/>
         <input id="saveroute" type="submit" value="Salvar cerca eletrônica" style="float:right;"></input>
       </div>
    </div>
  </div>

   <div id="map" style="float:right;height:450px;width:79%;background-color:white;"></div>
   </div>
</div>
{% endblock %}